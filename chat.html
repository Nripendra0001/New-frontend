<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SarkariNext | Mentor Chat</title>

  <link rel="icon" type="image/png" href="./favicon.png" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:Poppins,system-ui,Arial}
    body{background:#f7f8fb;color:#0f172a}

    .topbar{
      display:flex;align-items:center;gap:16px;
      padding:14px 16px;background:#0f172a;color:#fff;
      position:sticky;top:0;z-index:50
    }
    .site-logo{display:flex;align-items:center;gap:10px;cursor:pointer}
    .site-logo img{width:34px;height:34px;border-radius:10px}
    .site-logo span{font-weight:900}
    .live-bar{font-weight:700;opacity:.9}

    .chat-wrap{
      max-width:950px;margin:20px auto;padding:16px;
      background:#fff;border-radius:18px;
      border:1px solid rgba(15,23,42,.10)
    }

    .chat-top{text-align:center;margin-bottom:14px}
    .chat-top h2{font-size:22px;font-weight:900}
    .chat-top p{font-weight:700;opacity:.8;margin-top:6px}

    .chat-box{
      height:430px;overflow-y:auto;padding:14px;border-radius:16px;
      background:rgba(15,23,42,.04);
      border:1px solid rgba(15,23,42,.10)
    }

    .msg{display:flex;margin:10px 0}
    .msg.me{justify-content:flex-end}
    .msg.mentor{justify-content:flex-start}

    .bubble{
      max-width:78%;
      padding:12px 14px;border-radius:16px;
      font-weight:700;line-height:1.45;
      background:#fff;border:1px solid rgba(15,23,42,.10)
    }
    .msg.me .bubble{
      background:#0f172a;color:#fff;border-color:rgba(255,255,255,.15)
    }

    .chat-input{display:flex;gap:10px;margin-top:14px}
    .chat-input input{
      flex:1;padding:12px 14px;border-radius:14px;
      border:1px solid rgba(15,23,42,.15);outline:none;font-weight:700
    }
    .chat-input button{
      padding:12px 18px;border-radius:14px;border:none;
      background:#0f172a;color:#fff;font-weight:900;cursor:pointer;
      transition:.2s ease
    }
    .chat-input button:hover{transform:translateY(-2px);box-shadow:0 12px 25px rgba(15,23,42,.16)}

    .chat-note{
      margin-top:14px;padding:12px 14px;border-radius:16px;
      font-weight:800;background:rgba(15,23,42,.06);
      border:1px solid rgba(15,23,42,.10)
    }

    @media(max-width:700px){
      .live-bar{display:none}
      .chat-wrap{margin:0;border-radius:0;border:none}
      .bubble{max-width:92%}
    }
  </style>
</head>

<body>

<header class="topbar">
  <div class="site-logo" onclick="window.location.href='index.html'">
    <img src="./favicon.png" alt="SarkariNext Logo" />
    <span>SarkariNext</span>
  </div>

  <div class="live-bar">
    ðŸ’¬ Mentor Chat â€“ Ask doubts & get guidance
  </div>
</header>

<main class="chat-wrap">

  <div class="chat-top">
    <h2>ðŸ’¬ Chat with Mentor</h2>
    <p>Apna doubt likho. Mentor yahin reply karega.</p>
  </div>

  <div class="chat-box" id="chatBox"></div>

  <div class="chat-input">
    <input id="msg" type="text" placeholder="Type your message..." />
    <button onclick="sendMsg()">Send</button>
  </div>

  <div class="chat-note">
    âš¡ Tip: Agar mentor busy hai to reply thoda late aa sakta hai.
  </div>

</main>

<script>
  const API = "https://nripendra-backend.onrender.com";

  let roomId = localStorage.getItem("sn_roomId");
  let userName = localStorage.getItem("sn_userName") || "Student";

  const socket = io(API, { transports: ["websocket", "polling"] });

  async function initRoom() {
    if (!roomId) {
      const name = prompt("Apna naam likho (optional):") || "Student";
      userName = name;

      localStorage.setItem("sn_userName", userName);

      const res = await fetch(API + "/api/chat/create-room", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userName }),
      });

      const data = await res.json();
      roomId = data.roomId;

      localStorage.setItem("sn_roomId", roomId);
    }

    socket.emit("joinRoom", roomId);

    const msgsRes = await fetch(API + "/api/chat/messages/" + roomId);
    const data = await msgsRes.json();

    if (data.ok && Array.isArray(data.msgs)) {
      data.msgs.forEach(renderMessage);
    }

    socket.on("newMessage", (msg) => {
      if (msg.roomId === roomId) renderMessage(msg);
    });
  }

  function renderMessage(msg) {
    const div = document.createElement("div");
    div.className = "msg " + (msg.sender === "user" ? "me" : "mentor");

    div.innerHTML = `
      <div class="bubble">
        <b>${msg.sender === "user" ? "You" : "Mentor"}:</b><br>
        ${escapeHtml(msg.message)}
      </div>
    `;

    document.getElementById("chatBox").appendChild(div);
    document.getElementById("chatBox").scrollTop = 999999;
  }

  function sendMsg() {
    const input = document.getElementById("msg");
    const text = input.value.trim();
    if (!text) return;

    socket.emit("sendMessage", {
      roomId,
      sender: "user",
      senderName: userName,
      message: text,
    });

    input.value = "";
  }

  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#039;",
    }[m]));
  }

  initRoom();
</script>

</body>
</html>
