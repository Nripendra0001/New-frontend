<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SarkariNext | Mentor Dashboard</title>

  <link rel="icon" type="image/png" href="./favicon.png" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:Poppins,system-ui,Arial}
    body{background:#f7f8fb;color:#0f172a}

    .topbar{
      display:flex;align-items:center;gap:16px;
      padding:14px 16px;background:#0f172a;color:#fff;
      position:sticky;top:0;z-index:50
    }
    .site-logo{display:flex;align-items:center;gap:10px;cursor:pointer}
    .site-logo img{width:34px;height:34px;border-radius:10px}
    .site-logo span{font-weight:900}
    .live-bar{font-weight:700;opacity:.9}

    .mentor-wrap{
      display:grid;
      grid-template-columns:330px 1fr;
      gap:16px;
      max-width:1250px;
      margin:20px auto;
      padding:14px;
    }

    .mentor-left,.mentor-right{
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      border-radius:18px;
      padding:16px;
    }

    .mentor-left h2,.mentor-right h2{
      font-size:18px;font-weight:900
    }

    .room-list{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:520px;
      overflow-y:auto;
    }

    .room-item{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(15,23,42,.04);
      cursor:pointer;
      transition:.2s ease
    }
    .room-item:hover{transform:translateY(-2px);background:rgba(15,23,42,.07)}
    .room-item small{display:block;margin-top:4px;opacity:.75;font-weight:700}

    .room-empty{
      padding:14px;border-radius:16px;
      background:rgba(15,23,42,.05);
      border:1px solid rgba(15,23,42,.10);
      font-weight:800;text-align:center
    }

    .chat-box{
      height:430px;
      overflow-y:auto;
      padding:14px;
      border-radius:16px;
      background:rgba(15,23,42,.04);
      border:1px solid rgba(15,23,42,.10);
      margin-top:12px;
    }

    .msg{display:flex;margin:10px 0}
    .msg.me{justify-content:flex-end}
    .msg.mentor{justify-content:flex-start}

    .bubble{
      max-width:78%;
      padding:12px 14px;
      border-radius:16px;
      font-weight:700;
      line-height:1.45;
      background:#fff;
      border:1px solid rgba(15,23,42,.10)
    }
    .msg.mentor .bubble{
      background:#0f172a;color:#fff;border-color:rgba(255,255,255,.15)
    }

    .chat-input{display:flex;gap:10px;margin-top:14px}
    .chat-input input{
      flex:1;padding:12px 14px;border-radius:14px;
      border:1px solid rgba(15,23,42,.15);outline:none;font-weight:700
    }
    .chat-input button{
      padding:12px 18px;border-radius:14px;border:none;
      background:#0f172a;color:#fff;font-weight:900;cursor:pointer;
      transition:.2s ease
    }
    .chat-input button:hover{transform:translateY(-2px);box-shadow:0 12px 25px rgba(15,23,42,.16)}

    .logout-btn{
      width:100%;margin-top:14px;
      padding:12px;border-radius:14px;
      background:#0f172a;color:#fff;font-weight:900;
      border:none;cursor:pointer;transition:.2s ease
    }
    .logout-btn:hover{transform:translateY(-2px);box-shadow:0 12px 25px rgba(15,23,42,.16)}

    .chat-note{
      margin-top:14px;padding:12px 14px;border-radius:16px;
      font-weight:800;background:rgba(15,23,42,.06);
      border:1px solid rgba(15,23,42,.10)
    }

    @media(max-width:900px){
      .mentor-wrap{grid-template-columns:1fr}
      .live-bar{display:none}
    }
  </style>
</head>

<body>

<header class="topbar">
  <div class="site-logo" onclick="window.location.href='index.html'">
    <img src="./favicon.png" alt="SarkariNext Logo" />
    <span>SarkariNext</span>
  </div>

  <div class="live-bar">
    ðŸ“© Mentor Dashboard â€“ Reply to students
  </div>
</header>

<main class="mentor-wrap">

  <div class="mentor-left">
    <h2>ðŸ“© Student Chats</h2>
    <div id="rooms" class="room-list">Loading...</div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="mentor-right">
    <h2 id="roomTitle">Select a chat</h2>

    <div class="chat-box" id="chatBox"></div>

    <div class="chat-input">
      <input id="msg" type="text" placeholder="Reply..." />
      <button onclick="sendMsg()">Send</button>
    </div>

    <div class="chat-note">
      âš¡ Tip: Reply short & clear. Students ko direction do.
    </div>
  </div>

</main>

<script>
  const API = "https://nripendra-backend.onrender.com";
  const token = localStorage.getItem("sn_mentorToken");

  if (!token) window.location.href = "./mentor-login.html";

  const socket = io(API, { transports: ["websocket", "polling"] });

  let currentRoom = null;

  async function loadRooms() {
    const res = await fetch(API + "/api/chat/mentor/rooms", {
      headers: { Authorization: "Bearer " + token },
    });

    const data = await res.json();
    const list = document.getElementById("rooms");
    list.innerHTML = "";

    if (!data.ok || !data.rooms || !data.rooms.length) {
      list.innerHTML = "<div class='room-empty'>No chats yet.</div>";
      return;
    }

    data.rooms.forEach((r) => {
      const div = document.createElement("div");
      div.className = "room-item";
      div.innerHTML = `
        <b>${r._id}</b>
        <small>${escapeHtml(r.lastMessage || "")}</small>
      `;
      div.onclick = () => openRoom(r._id);
      list.appendChild(div);
    });
  }

  async function openRoom(roomId) {
    currentRoom = roomId;

    document.getElementById("roomTitle").innerText = "Room: " + roomId;
    document.getElementById("chatBox").innerHTML = "";

    socket.emit("joinRoom", roomId);

    const res = await fetch(API + "/api/chat/messages/" + roomId);
    const data = await res.json();

    if (data.ok && Array.isArray(data.msgs)) {
      data.msgs.forEach(renderMessage);
    }

    socket.off("newMessage");
    socket.on("newMessage", (msg) => {
      if (msg.roomId === currentRoom) renderMessage(msg);
    });
  }

  function renderMessage(msg) {
    const div = document.createElement("div");
    div.className = "msg " + (msg.sender === "mentor" ? "mentor" : "me");

    div.innerHTML = `
      <div class="bubble">
        <b>${msg.sender === "mentor" ? "Mentor" : "Student"}:</b><br>
        ${escapeHtml(msg.message)}
      </div>
    `;

    document.getElementById("chatBox").appendChild(div);
    document.getElementById("chatBox").scrollTop = 999999;
  }

  function sendMsg() {
    if (!currentRoom) return alert("Select a chat first!");

    const input = document.getElementById("msg");
    const text = input.value.trim();
    if (!text) return;

    socket.emit("sendMessage", {
      roomId: currentRoom,
      sender: "mentor",
      senderName: "Mentor",
      message: text,
    });

    input.value = "";
  }

  function logout() {
    localStorage.removeItem("sn_mentorToken");
    window.location.href = "./mentor-login.html";
  }

  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#039;",
    }[m]));
  }

  loadRooms();
</script>

</body>
</html>
